<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Moltiverse Zoo Command Center</title>
    <!-- Reown AppKit bundle (built from npm packages) -->
    <script src="/reown-appkit.bundle.js" defer onload="window.REOWN_BUNDLE_LOADED = true"></script>
    <style>
      :root {
        color-scheme: dark;
        --bg: #0a0f0b;
        --card: #121a16;
        --muted: #8aa29b;
        --accent: #89f0c5;
        --accent-2: #5bd4ff;
        --trader: #5ba7ff;
        --breeder: #ff8dc0;
        --explorer: #46e5a5;
        --gold: #f7c873;
        --shadow: 0 20px 45px rgba(0, 0, 0, 0.35);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family:
          "SF Pro Rounded",
          ui-sans-serif,
          system-ui,
          -apple-system,
          sans-serif;
        background:
          radial-gradient(circle at top, rgba(46, 80, 64, 0.4), transparent 55%), var(--bg);
        color: #e8f4ef;
        transition: background 1.2s ease;
      }

      body.day {
        background:
          radial-gradient(circle at top, rgba(100, 180, 140, 0.6), transparent 55%), #0b1310;
      }

      body.night {
        background: radial-gradient(circle at top, rgba(30, 60, 90, 0.5), transparent 60%), #050709;
      }

      header {
        padding: 28px 36px 16px;
        display: grid;
        gap: 12px;
      }

      .hero {
        display: grid;
        gap: 6px;
      }

      .hero h1 {
        margin: 0;
        font-size: 28px;
      }

      .hero p {
        margin: 0;
        color: var(--muted);
      }

      .hero-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        color: var(--muted);
        font-size: 12px;
      }

      /* Auth Modal */
      .auth-modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        backdrop-filter: blur(4px);
        opacity: 1;
        transition: opacity 0.3s ease;
      }

      .auth-modal.hidden {
        display: none;
      }

      .auth-card {
        background: linear-gradient(135deg, rgba(66, 120, 98, 0.4), transparent), var(--card);
        border: 1px solid rgba(137, 240, 197, 0.2);
        border-radius: 24px;
        padding: 40px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 40px 80px rgba(0, 0, 0, 0.5);
      }

      .auth-card h2 {
        margin: 0 0 24px;
        font-size: 24px;
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .auth-form {
        display: grid;
        gap: 16px;
      }

      .form-group {
        display: grid;
        gap: 6px;
      }

      .form-group label {
        font-size: 12px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.1em;
      }

      .form-group input {
        background: rgba(137, 240, 197, 0.05);
        border: 1px solid rgba(137, 240, 197, 0.2);
        border-radius: 10px;
        padding: 12px 16px;
        color: #e8f4ef;
        font-family: monospace;
        font-size: 12px;
      }

      .form-group input::placeholder {
        color: rgba(255, 255, 255, 0.3);
      }

      .auth-buttons {
        display: grid;
        gap: 12px;
        margin-top: 20px;
      }

      .btn {
        padding: 12px 20px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        font-weight: 500;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        transition: all 0.3s ease;
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        color: var(--bg);
      }

      .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 12px 24px rgba(137, 240, 197, 0.3);
      }

      .btn-secondary {
        background: rgba(137, 240, 197, 0.1);
        color: var(--accent);
        border: 1px solid rgba(137, 240, 197, 0.3);
      }

      .btn-secondary:hover:not(:disabled) {
        background: rgba(137, 240, 197, 0.2);
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .auth-status {
        padding: 12px;
        border-radius: 10px;
        font-size: 12px;
        margin-top: 12px;
      }

      .status-success {
        background: rgba(70, 229, 165, 0.1);
        color: var(--explorer);
        border: 1px solid rgba(70, 229, 165, 0.3);
      }

      .status-error {
        background: rgba(255, 107, 107, 0.1);
        color: #ff6b6b;
        border: 1px solid rgba(255, 107, 107, 0.3);
      }

      .status-info {
        background: rgba(91, 167, 255, 0.1);
        color: var(--trader);
        border: 1px solid rgba(91, 167, 255, 0.3);
      }

      .wallet-display {
        background: rgba(137, 240, 197, 0.05);
        border: 1px solid rgba(137, 240, 197, 0.2);
        border-radius: 10px;
        padding: 12px;
        margin-top: 12px;
        font-family: monospace;
        font-size: 12px;
        color: var(--accent);
        word-break: break-all;
      }

      .auth-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin-bottom: 24px;
      }

      .wallet-badge {
        background: rgba(70, 229, 165, 0.1);
        border: 1px solid rgba(70, 229, 165, 0.3);
        border-radius: 20px;
        padding: 6px 14px;
        font-size: 11px;
        color: var(--explorer);
      }

      main {
        padding: 0 36px 36px;
        display: grid;
        gap: 20px;
      }

      .grid {
        display: grid;
        gap: 18px;
      }

      .stats {
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      }

      .stat-card {
        background: linear-gradient(135deg, rgba(66, 120, 98, 0.3), transparent 70%), var(--card);
        padding: 16px;
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid rgba(137, 240, 197, 0.1);
      }

      .stat-card h3 {
        margin: 0 0 8px;
        font-size: 11px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.2em;
      }

      .stat-card p {
        margin: 0;
        font-size: 22px;
      }

      .zones {
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      }

      .zone {
        background: var(--card);
        border-radius: 18px;
        padding: 16px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        position: relative;
        overflow: hidden;
      }

      .zone::after {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at top, rgba(255, 255, 255, 0.08), transparent 60%);
        pointer-events: none;
      }

      .zone h4 {
        margin: 0 0 6px;
        font-size: 14px;
      }

      .zone p {
        margin: 0;
        color: var(--muted);
        font-size: 12px;
      }

      .zone .count {
        font-size: 28px;
        font-weight: 700;
        margin-top: 10px;
      }

      .zone.trader {
        border-color: rgba(91, 167, 255, 0.3);
      }

      .zone.breeder {
        border-color: rgba(255, 141, 192, 0.3);
      }

      .zone.explorer {
        border-color: rgba(70, 229, 165, 0.3);
      }

      .map-panel {
        background:
          linear-gradient(180deg, rgba(34, 58, 44, 0.4), rgba(15, 20, 17, 0.9)), var(--card);
        border-radius: 20px;
        padding: 16px;
        border: 1px solid rgba(137, 240, 197, 0.12);
        box-shadow: var(--shadow);
      }

      .map-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }

      .map-header h2 {
        margin: 0;
        font-size: 16px;
      }

      .map-legend {
        display: flex;
        gap: 10px;
        font-size: 11px;
        color: var(--muted);
      }

      .map-controls {
        display: flex;
        gap: 6px;
      }

      .map-controls button {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.15);
        color: #e8f4ef;
        border-radius: 8px;
        padding: 4px 8px;
        cursor: pointer;
      }

      .map {
        position: relative;
        height: 340px;
        border-radius: 16px;
        overflow: hidden;
        background-color: #0d1412;
        background-image:
          linear-gradient(transparent 70%, rgba(0, 0, 0, 0.2)),
          repeating-linear-gradient(
            0deg,
            rgba(255, 255, 255, 0.05),
            rgba(255, 255, 255, 0.05) 1px,
            transparent 1px,
            transparent 24px
          ),
          repeating-linear-gradient(
            90deg,
            rgba(255, 255, 255, 0.05),
            rgba(255, 255, 255, 0.05) 1px,
            transparent 1px,
            transparent 24px
          );
      }

      .map-scene {
        position: absolute;
        inset: 0;
        transform-origin: center;
      }

      .map canvas {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
      }

      .zone-overlay {
        position: absolute;
        inset: 10px;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        z-index: 2;
      }

      .zone-tile {
        border-radius: 14px;
        padding: 10px;
        font-size: 11px;
        color: rgba(255, 255, 255, 0.75);
        border: 1px solid rgba(255, 255, 255, 0.08);
        background: rgba(255, 255, 255, 0.03);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }

      .zone-tile.trader {
        background: rgba(91, 167, 255, 0.08);
      }

      .zone-tile.breeder {
        background: rgba(255, 141, 192, 0.08);
      }

      .zone-tile.explorer {
        background: rgba(70, 229, 165, 0.08);
      }

      .map-tokens {
        position: absolute;
        inset: 0;
        z-index: 3;
      }

      .agent-token {
        position: absolute;
        transform: translate(-50%, -50%);
        display: grid;
        place-items: center;
        width: 40px;
        height: 40px;
        border-radius: 14px;
        background: rgba(18, 26, 22, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.35);
        animation: float 4s ease-in-out infinite;
      }

      .agent-token span {
        font-size: 20px;
      }

      .agent-token.trader {
        border-color: rgba(91, 167, 255, 0.6);
      }

      .agent-token.breeder {
        border-color: rgba(255, 141, 192, 0.6);
      }

      .agent-token.explorer {
        border-color: rgba(70, 229, 165, 0.6);
      }

      .agent-token .badge-dot {
        position: absolute;
        bottom: -4px;
        right: -4px;
        padding: 2px 6px;
        font-size: 9px;
        border-radius: 999px;
        background: rgba(0, 0, 0, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      @keyframes float {
        0%,
        100% {
          transform: translate(-50%, -50%) translateY(0px);
        }

        50% {
          transform: translate(-50%, -50%) translateY(-6px);
        }
      }

      .layout {
        display: grid;
        grid-template-columns: 1.6fr 1fr;
        gap: 20px;
      }

      @media (max-width: 1024px) {
        .layout {
          grid-template-columns: 1fr;
        }
      }

      .replay {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 12px;
        margin-bottom: 12px;
      }

      .replay input[type="range"] {
        flex: 1;
      }

      .agents-grid {
        display: grid;
        gap: 14px;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      }

      .agent-card {
        background: var(--card);
        padding: 16px;
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        box-shadow: var(--shadow);
        display: grid;
        gap: 6px;
      }

      .agent-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .portrait {
        width: 48px;
        height: 48px;
        border-radius: 14px;
        display: grid;
        place-items: center;
        font-size: 22px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.15);
      }

      .badge {
        font-size: 11px;
        padding: 4px 10px;
        border-radius: 999px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .badge.trader {
        background: rgba(91, 167, 255, 0.2);
        color: var(--trader);
      }

      .badge.breeder {
        background: rgba(255, 141, 192, 0.2);
        color: var(--breeder);
      }

      .badge.explorer {
        background: rgba(70, 229, 165, 0.2);
        color: var(--explorer);
      }

      .energy {
        height: 8px;
        border-radius: 999px;
        background: #1b2520;
        overflow: hidden;
        margin: 4px 0;
      }

      .energy span {
        display: block;
        height: 100%;
        background: linear-gradient(90deg, var(--accent), var(--accent-2));
      }

      .muted {
        color: var(--muted);
        font-size: 12px;
      }

      .traits {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }

      .trait {
        font-size: 10px;
        padding: 2px 8px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.08);
        color: var(--muted);
      }

      .sidebar {
        display: grid;
        gap: 16px;
      }

      .panel {
        background: var(--card);
        padding: 16px;
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.05);
      }

      .panel h3 {
        margin: 0 0 10px;
        font-size: 14px;
      }

      .cinematic {
        background:
          linear-gradient(140deg, rgba(91, 167, 255, 0.2), rgba(15, 20, 17, 0.8)), var(--card);
        border-radius: 18px;
        padding: 16px;
        border: 1px solid rgba(91, 167, 255, 0.3);
      }

      .portrait-row {
        display: flex;
        gap: 12px;
        align-items: center;
      }

      .timeline {
        margin-top: 10px;
        display: grid;
        gap: 6px;
        font-size: 12px;
      }

      .feed {
        display: grid;
        gap: 10px;
        max-height: 320px;
        overflow: auto;
      }

      .feed-item {
        padding: 10px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.04);
        font-size: 12px;
      }

      .feed-item strong {
        color: var(--gold);
      }

      .controls {
        display: grid;
        gap: 10px;
      }

      .controls button {
        background: rgba(137, 240, 197, 0.15);
        border: 1px solid rgba(137, 240, 197, 0.3);
        color: #e8f4ef;
        padding: 8px 12px;
        border-radius: 10px;
        cursor: pointer;
      }

      .controls input,
      .controls select {
        width: 100%;
        padding: 6px 8px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        background: rgba(0, 0, 0, 0.3);
        color: #e8f4ef;
      }
    </style>
  </head>

  <body>
    <!-- Auth Modal -->
    <div class="auth-modal" id="auth-modal">
      <div class="auth-card">
        <h2>ü¶û Connect Wallet</h2>
        <div id="auth-content">
          <div class="auth-form">
            <!-- Auto-connect section -->
            <div id="auto-connect-section">
              <div style="text-align: center; margin-bottom: 24px">
                <p style="color: var(--muted); margin-bottom: 16px">
                  Connect your wallet to access Moltiverse Zoo
                </p>
                <button
                  class="btn btn-primary"
                  onclick="connectWalletAuto()"
                  style="width: 100%; font-size: 16px; padding: 16px"
                >
                  üîó Connect Wallet
                </button>
                <p style="color: var(--muted); font-size: 12px; margin-top: 12px">
                  Supports MetaMask, Backpack, Coinbase Wallet & more
                </p>
                <p style="color: var(--muted); font-size: 11px; margin-top: 4px">
                  Requires ZOO tokens on Monad Mainnet
                </p>
              </div>
              <div style="text-align: center; margin: 24px 0">
                <span style="color: var(--muted); font-size: 12px">OR</span>
              </div>
              <button class="btn" onclick="showManualAuth()" style="width: 100%">
                Manual Sign-In
              </button>
            </div>

            <!-- Manual auth section (hidden by default) -->
            <div id="manual-auth-section" style="display: none">
              <div class="form-group">
                <label for="wallet-input">Wallet Address (0x...)</label>
                <input
                  type="text"
                  id="wallet-input"
                  placeholder="0x..."
                  pattern="^0x[a-fA-F0-9]{40}$"
                />
              </div>
              <div id="challenge-display" style="display: none">
                <div class="form-group">
                  <label>Message to Sign (copy to your wallet)</label>
                  <div
                    class="wallet-display"
                    id="challenge-text"
                    style="white-space: pre-wrap; word-break: break-word"
                  ></div>
                </div>
                <div class="form-group">
                  <label for="signature-input">Signed Message (paste result)</label>
                  <input type="text" id="signature-input" placeholder="0x..." />
                </div>
              </div>
              <div class="auth-buttons">
                <button class="btn" onclick="showAutoConnect()">‚Üê Back to Auto-Connect</button>
                <button
                  class="btn btn-primary"
                  id="btn-create-challenge"
                  onclick="createChallenge()"
                >
                  Create Challenge
                </button>
                <button
                  class="btn btn-primary"
                  id="btn-verify"
                  style="display: none"
                  onclick="verifySignature()"
                >
                  Verify & Login
                </button>
              </div>
            </div>

            <div id="auth-status-display"></div>
          </div>
        </div>
      </div>
    </div>

    <header>
      <div class="hero">
        <h1>ü¶û Moltiverse Zoo Command Center</h1>
        <p>
          Watch the ecosystem evolve in real time. Traders hunt profit, breeders grow the lineage,
          explorers map the unknown.
        </p>
      </div>
      <div class="hero-meta">
        <span id="last-update">Waiting for data‚Ä¶</span>
        <span id="resource-summary"></span>
        <span id="wallet-badge" style="display: none"></span>
      </div>
    </header>
    <main>
      <section class="grid stats" id="stats"></section>
      <section class="grid zones" id="zones"></section>
      <section class="map-panel">
        <div class="map-header">
          <h2>Live Zoo Map</h2>
          <div class="map-controls">
            <button id="zoom-in">Ôºã</button>
            <button id="zoom-out">Ôºç</button>
            <button id="zoom-reset">Reset</button>
          </div>
          <div class="map-legend">
            <span>ü¶Å Trader</span>
            <span>üê¢ Breeder</span>
            <span>ü¶Ö Explorer</span>
          </div>
        </div>
        <div class="map" id="map">
          <div class="map-scene" id="map-scene">
            <canvas id="trail-canvas"></canvas>
            <canvas id="overlay-canvas"></canvas>
            <div class="zone-overlay">
              <div class="zone-tile trader">
                <strong>Trader Enclave</strong>
                <span>Market stalls ¬∑ High traffic</span>
              </div>
              <div class="zone-tile breeder">
                <strong>Breeder Grove</strong>
                <span>Nursery ¬∑ Safe nests</span>
              </div>
              <div class="zone-tile explorer">
                <strong>Explorer Wilds</strong>
                <span>Unmapped trails ¬∑ Fog</span>
              </div>
            </div>
            <div class="map-tokens" id="map-tokens"></div>
          </div>
        </div>
      </section>
      <section class="layout">
        <div>
          <h2>Active Habitats</h2>
          <div class="replay">
            <label><input type="checkbox" id="replay-toggle" /> Replay mode</label>
            <input type="range" min="0" max="0" value="0" id="replay-slider" />
          </div>
          <div class="agents-grid" id="agents"></div>
        </div>
        <aside class="sidebar">
          <div class="panel cinematic" id="cinematic">
            <h3>Cinematic Spotlight</h3>
            <div class="portrait-row">
              <div class="portrait" id="spotlight-portrait">ü¶ä</div>
              <div>
                <strong id="spotlight-name">Awaiting agents</strong>
                <div class="muted" id="spotlight-meta"></div>
              </div>
            </div>
            <div class="timeline" id="spotlight-timeline"></div>
          </div>
          <div class="panel">
            <h3>Live Activity Feed</h3>
            <div class="feed" id="feed"></div>
          </div>
          <div class="panel">
            <h3>Zoo Controls</h3>
            <div class="controls">
              <button id="sim-start">Start Simulation</button>
              <button id="sim-stop">Stop Simulation</button>
              <label class="muted"
                >Steps <input type="number" id="sim-steps" value="20" min="1"
              /></label>
              <label class="muted"
                >Interval (s) <input type="number" step="0.5" id="sim-interval" value="1.5"
              /></label>
              <label class="muted"
                >Provider
                <select id="sim-provider">
                  <option value="ollama">Ollama</option>
                  <option value="openai">OpenAI</option>
                </select>
              </label>
              <label class="muted"
                >Spawn Type
                <select id="spawn-type">
                  <option value="trader">Trader</option>
                  <option value="breeder">Breeder</option>
                  <option value="explorer">Explorer</option>
                </select>
              </label>
              <label class="muted"
                >Energy <input type="number" id="spawn-energy" value="100"
              /></label>
              <button id="spawn-agent">Spawn Agent</button>
              <div class="muted" id="controls"></div>
            </div>
          </div>
        </aside>
      </section>
    </main>
    <script>
      const statsEl = document.getElementById("stats");
      const agentsEl = document.getElementById("agents");
      const zonesEl = document.getElementById("zones");
      const feedEl = document.getElementById("feed");
      const mapEl = document.getElementById("map");
      const mapScene = document.getElementById("map-scene");
      const mapTokens = document.getElementById("map-tokens");
      const trailCanvas = document.getElementById("trail-canvas");
      const overlayCanvas = document.getElementById("overlay-canvas");
      const lastUpdateEl = document.getElementById("last-update");
      const resourceSummaryEl = document.getElementById("resource-summary");
      const controlsEl = document.getElementById("controls");
      const replayToggle = document.getElementById("replay-toggle");
      const replaySlider = document.getElementById("replay-slider");
      const spotlightPortrait = document.getElementById("spotlight-portrait");
      const spotlightName = document.getElementById("spotlight-name");
      const spotlightMeta = document.getElementById("spotlight-meta");
      const spotlightTimeline = document.getElementById("spotlight-timeline");
      const simStartBtn = document.getElementById("sim-start");
      const simStopBtn = document.getElementById("sim-stop");
      const simStepsInput = document.getElementById("sim-steps");
      const simIntervalInput = document.getElementById("sim-interval");
      const simProviderSelect = document.getElementById("sim-provider");
      const spawnTypeSelect = document.getElementById("spawn-type");
      const spawnEnergyInput = document.getElementById("spawn-energy");
      const spawnAgentBtn = document.getElementById("spawn-agent");
      const zoomInBtn = document.getElementById("zoom-in");
      const zoomOutBtn = document.getElementById("zoom-out");
      const zoomResetBtn = document.getElementById("zoom-reset");

      let lastTransactions = [];
      const positions = new Map();
      const lastPositions = new Map();
      let trailCtx;
      let overlayCtx;
      let canvasReady = false;
      let spotlightIndex = 0;
      let snapshots = [];
      let liveData = null;
      let zoom = 1;
      let pan = { x: 0, y: 0 };
      let dragging = false;
      let dragStart = { x: 0, y: 0 };

      const iconMap = { trader: "ü¶Å", breeder: "üê¢", explorer: "ü¶Ö" };
      const badgeMap = {
        trade: "TRADE",
        alliance: "NEW ALLIANCE",
        reproduce: "OFFSPRING",
        explore: "EXPLORE",
      };

      function statCard(label, value) {
        return `
          <div class="stat-card">
            <h3>${label}</h3>
            <p>${value}</p>
          </div>
        `;
      }

      function zoneCard(label, count, description, type) {
        return `
          <div class="zone ${type}">
            <h4>${label}</h4>
            <p>${description}</p>
            <div class="count">${count}</div>
          </div>
        `;
      }

      function energyTier(energy) {
        if (energy >= 120) return "High Energy";
        if (energy >= 90) return "Steady";
        return "Needs boost";
      }

      function agentCard(agent) {
        const energyPct = Math.min(100, Math.max(0, (agent.energy / 150) * 100));
        const icon = iconMap[agent.type] || "ü¶é";
        return `
          <div class="agent-card" data-agent-id="${agent.id}">
            <div class="agent-header">
              <div style="display:flex; gap:10px; align-items:center;">
                <div class="portrait">${icon}</div>
                <strong>${agent.id}</strong>
              </div>
              <span class="badge ${agent.type}">${agent.type}</span>
            </div>
            <div class="muted">Energy: ${agent.energy}</div>
            <div class="energy"><span style="width:${energyPct}%"></span></div>
            <div class="muted">Food: ${agent.resources.food} ¬∑ Materials: ${agent.resources.materials}</div>
            <div class="traits">
              <span class="trait">Gen ${agent.generation}</span>
              <span class="trait">${energyTier(agent.energy)}</span>
              <span class="trait">Alliances ${agent.alliances.length}</span>
            </div>
          </div>
        `;
      }

      function randomPosition() {
        return { x: Math.random() * 90 + 5, y: Math.random() * 80 + 10 };
      }

      function setupCanvas() {
        if (canvasReady) return;
        const rect = mapEl.getBoundingClientRect();
        const ratio = window.devicePixelRatio || 1;
        trailCanvas.width = rect.width * ratio;
        trailCanvas.height = rect.height * ratio;
        overlayCanvas.width = rect.width * ratio;
        overlayCanvas.height = rect.height * ratio;
        trailCtx = trailCanvas.getContext("2d");
        overlayCtx = overlayCanvas.getContext("2d");
        trailCtx.scale(ratio, ratio);
        overlayCtx.scale(ratio, ratio);
        canvasReady = true;
      }

      function drawTrail(from, to, type) {
        if (!trailCtx) return;
        const color =
          type === "trader"
            ? "rgba(91, 167, 255, 0.5)"
            : type === "breeder"
              ? "rgba(255, 141, 192, 0.5)"
              : "rgba(70, 229, 165, 0.5)";
        trailCtx.strokeStyle = color;
        trailCtx.lineWidth = 2;
        trailCtx.beginPath();
        trailCtx.moveTo(from.x, from.y);
        trailCtx.lineTo(to.x, to.y);
        trailCtx.stroke();
      }

      function drawHeatmap(agents) {
        if (!overlayCtx) return;
        agents.forEach((agent) => {
          const pos = positions.get(agent.id) || randomPosition();
          const x = (pos.x / 100) * mapEl.clientWidth;
          const y = (pos.y / 100) * mapEl.clientHeight;
          const radius = 20 + Math.min(45, agent.energy / 3);
          const color =
            agent.type === "trader"
              ? "rgba(91, 167, 255, 0.12)"
              : agent.type === "breeder"
                ? "rgba(255, 141, 192, 0.12)"
                : "rgba(70, 229, 165, 0.12)";
          overlayCtx.beginPath();
          overlayCtx.fillStyle = color;
          overlayCtx.arc(x, y, radius, 0, Math.PI * 2);
          overlayCtx.fill();
        });
      }

      function drawAllianceLinks(agents) {
        if (!overlayCtx) return;
        const agentMap = new Map(agents.map((a) => [a.id, a]));
        agents.forEach((agent) => {
          (agent.alliances || []).forEach((ally) => {
            const target = agentMap.get(ally);
            if (!target) return;
            const posA = positions.get(agent.id) || randomPosition();
            const posB = positions.get(target.id) || randomPosition();
            const x1 = (posA.x / 100) * mapEl.clientWidth;
            const y1 = (posA.y / 100) * mapEl.clientHeight;
            const x2 = (posB.x / 100) * mapEl.clientWidth;
            const y2 = (posB.y / 100) * mapEl.clientHeight;
            overlayCtx.strokeStyle = "rgba(247, 200, 115, 0.5)";
            overlayCtx.lineWidth = 2;
            overlayCtx.beginPath();
            overlayCtx.moveTo(x1, y1);
            overlayCtx.lineTo(x2, y2);
            overlayCtx.stroke();
          });
        });
      }

      function latestEventBadge(agentId) {
        const tx = (lastTransactions || [])
          .slice()
          .reverse()
          .find((t) => t.agent_id === agentId || t.partner_id === agentId);
        return tx ? badgeMap[tx.type] || "" : "";
      }

      function renderMap(agents) {
        setupCanvas();
        if (trailCtx && overlayCtx) {
          trailCtx.fillStyle = "rgba(13, 20, 18, 0.12)";
          trailCtx.fillRect(0, 0, trailCanvas.width, trailCanvas.height);
          overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
        }

        const tokens = agents.map((agent) => {
          if (!positions.has(agent.id)) {
            positions.set(agent.id, randomPosition());
          } else {
            const pos = positions.get(agent.id);
            pos.x = Math.min(95, Math.max(5, pos.x + (Math.random() - 0.5) * 4));
            pos.y = Math.min(90, Math.max(10, pos.y + (Math.random() - 0.5) * 3));
          }

          const pos = positions.get(agent.id);
          const pixelPos = {
            x: (pos.x / 100) * mapEl.clientWidth,
            y: (pos.y / 100) * mapEl.clientHeight,
          };

          if (lastPositions.has(agent.id)) {
            drawTrail(lastPositions.get(agent.id), pixelPos, agent.type);
          }
          lastPositions.set(agent.id, pixelPos);

          const badge = latestEventBadge(agent.id);
          return `
                  <div class="agent-token ${agent.type}" style="left:${pos.x}%; top:${pos.y}%">
                    <span>${iconMap[agent.type] || "ü¶é"}</span>
                    ${badge ? `<div class="badge-dot">${badge}</div>` : ""}
                  </div>
                `;
        });

        drawHeatmap(agents);
        drawAllianceLinks(agents);

        mapTokens.innerHTML = tokens.join("");
      }

      function renderFeed(transactions) {
        if (!transactions.length) {
          feedEl.innerHTML = `
                    <div class="feed-item" style="text-align: center; padding: 20px;">
                        <div style="font-size: 32px; margin-bottom: 10px;">ü¶ä</div>
                        <div style="color: var(--muted);">No activity yet</div>
                        <div style="font-size: 12px; color: var(--muted); margin-top: 8px;">
                            Start the simulation or manually trigger agent actions to see activity
                        </div>
                    </div>
                `;
          return;
        }

        feedEl.innerHTML = transactions
          .slice(-8)
          .reverse()
          .map((tx) => {
            const type = tx.type || "event";
            const actor = tx.agent_id || "unknown";
            const detail =
              type === "trade"
                ? `Traded ${tx.amount} ${tx.resource} for ${tx.price} energy`
                : type === "reproduce"
                  ? `New offspring ${tx.offspring_id}`
                  : type === "alliance"
                    ? `Alliance with ${tx.partner_id}`
                    : type === "explore"
                      ? `Explored: +${tx.food_gain} food, +${tx.materials_gain} materials`
                      : "Activity detected";
            return `
          <div class="feed-item">
            <strong>${actor}</strong> ¬∑ ${type}<br />
            ${detail}
          </div>
        `;
          })
          .join("");
      }

      function renderSpotlight(data) {
        if (!data || !data.agents.length) {
          spotlightName.textContent = "Awaiting agents";
          spotlightMeta.textContent = "";
          spotlightTimeline.innerHTML = "";
          spotlightPortrait.textContent = "ü¶ä";
          return;
        }
        const agent = data.agents[spotlightIndex % data.agents.length];
        const icon = iconMap[agent.type] || "ü¶ä";
        spotlightPortrait.textContent = icon;
        spotlightName.textContent = agent.id;
        spotlightMeta.textContent = `${agent.type.toUpperCase()} ¬∑ Energy ${agent.energy} ¬∑ Gen ${agent.generation}`;
        const events =
          (data.recent_transactions || [])
            .filter((tx) => tx.agent_id === agent.id || tx.partner_id === agent.id)
            .slice(-4)
            .reverse()
            .map(
              (tx) =>
                `<div><strong>${tx.type}</strong> <span class="muted">${tx.agent_id || ""}</span></div>`,
            )
            .join("") || "<span>No recent events.</span>";
        spotlightTimeline.innerHTML = events;
      }

      function setDayNight() {
        const hour = new Date().getHours();
        document.body.classList.toggle("night", hour < 6 || hour > 19);
        document.body.classList.toggle("day", hour >= 6 && hour <= 19);
      }

      function updateMapTransform() {
        mapScene.style.transform = `translate(${pan.x}px, ${pan.y}px) scale(${zoom})`;
      }

      async function controlRequest(path, body = {}) {
        await fetch(path, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
      }

      function renderFrame(data) {
        statsEl.innerHTML = [
          statCard("Total Agents", data.statistics.total_agents),
          statCard("Active", data.statistics.active_agents),
          statCard("Total Energy", data.statistics.total_energy),
          statCard("Transactions", data.statistics.total_transactions),
          statCard("Food Pool", data.resources.global_pool.food),
          statCard("Materials Pool", data.resources.global_pool.materials),
        ].join("");

        zonesEl.innerHTML = [
          zoneCard(
            "Trader Enclave",
            data.statistics.agent_types.trader || 0,
            "Profit hunters and market makers",
            "trader",
          ),
          zoneCard(
            "Breeder Grove",
            data.statistics.agent_types.breeder || 0,
            "Lineage builders and alliance seekers",
            "breeder",
          ),
          zoneCard(
            "Explorer Wilds",
            data.statistics.agent_types.explorer || 0,
            "Resource scouts and territory claimers",
            "explorer",
          ),
        ].join("");

        agentsEl.innerHTML = data.agents.map(agentCard).join("");
        renderMap(data.agents);
        lastUpdateEl.textContent = `Updated ${new Date().toLocaleTimeString()}`;
        resourceSummaryEl.textContent = `Global Pool ¬∑ Food ${data.resources.global_pool.food} / Materials ${data.resources.global_pool.materials}`;

        if (JSON.stringify(lastTransactions) !== JSON.stringify(data.recent_transactions)) {
          lastTransactions = data.recent_transactions || [];
          renderFeed(lastTransactions);
        }

        controlsEl.textContent = `Agents active: ${data.statistics.active_agents} ¬∑ Total energy: ${data.statistics.total_energy}`;
        renderSpotlight(data);
      }

      async function fetchStatus() {
        const res = await fetch("/api/status");
        const data = await res.json();
        liveData = data;
        snapshots = [...snapshots, data].slice(-50);
        replaySlider.max = Math.max(0, snapshots.length - 1);

        if (replayToggle.checked) {
          const index = Number(replaySlider.value || 0);
          renderFrame(snapshots[index] || data);
          return;
        }

        renderFrame(data);
      }

      replayToggle.addEventListener("change", () => {
        if (replayToggle.checked && snapshots.length) {
          replaySlider.value = String(snapshots.length - 1);
          renderFrame(snapshots[snapshots.length - 1]);
        }
      });

      replaySlider.addEventListener("input", () => {
        if (!snapshots.length) return;
        renderFrame(snapshots[Number(replaySlider.value)] || snapshots[0]);
      });

      simStartBtn.addEventListener("click", async () => {
        await controlRequest("/api/control/sim/start", {
          steps: Number(simStepsInput.value || 20),
          interval: Number(simIntervalInput.value || 1.5),
          provider: simProviderSelect.value,
        });
      });

      simStopBtn.addEventListener("click", async () => {
        await controlRequest("/api/control/sim/stop");
      });

      spawnAgentBtn.addEventListener("click", async () => {
        await controlRequest("/api/control/spawn", {
          type: spawnTypeSelect.value,
          energy: Number(spawnEnergyInput.value || 100),
        });
      });

      zoomInBtn.addEventListener("click", () => {
        zoom = Math.min(2.5, zoom + 0.1);
        updateMapTransform();
      });

      zoomOutBtn.addEventListener("click", () => {
        zoom = Math.max(0.6, zoom - 0.1);
        updateMapTransform();
      });

      zoomResetBtn.addEventListener("click", () => {
        zoom = 1;
        pan = { x: 0, y: 0 };
        updateMapTransform();
      });

      mapEl.addEventListener("mousedown", (event) => {
        dragging = true;
        dragStart = { x: event.clientX - pan.x, y: event.clientY - pan.y };
      });

      window.addEventListener("mousemove", (event) => {
        if (!dragging) return;
        pan = { x: event.clientX - dragStart.x, y: event.clientY - dragStart.y };
        updateMapTransform();
      });

      window.addEventListener("mouseup", () => {
        dragging = false;
      });

      mapEl.addEventListener(
        "wheel",
        (event) => {
          event.preventDefault();
          zoom = Math.min(2.5, Math.max(0.6, zoom + (event.deltaY > 0 ? -0.1 : 0.1)));
          updateMapTransform();
        },
        { passive: false },
      );

      agentsEl.addEventListener("click", (event) => {
        const card = event.target.closest(".agent-card");
        if (!card || !liveData) return;
        const id = card.getAttribute("data-agent-id");
        const index = liveData.agents.findIndex((agent) => agent.id === id);
        if (index >= 0) {
          spotlightIndex = index;
          renderSpotlight(liveData);
        }
      });

      setDayNight();
      updateMapTransform();
      setInterval(setDayNight, 60000);
      setInterval(() => {
        spotlightIndex += 1;
        if (liveData) renderSpotlight(liveData);
      }, 6000);

      // ========== AUTHENTICATION ==========
      let sessionToken = localStorage.getItem("zoo_session_token");
      let userWallet = localStorage.getItem("zoo_wallet");
      let MIN_TOKEN_BALANCE = 0; // Will be loaded from /api/config

      // Load config from backend
      async function loadConfig() {
        try {
          const response = await fetch("/api/config");
          const config = await response.json();
          MIN_TOKEN_BALANCE = config.minTokenBalance || 0;
          window.REOWN_PROJECT_ID = config.reownProjectId || "";
          window.MONAD_RPC_URL = config.monadRpcUrl || "https://rpc.monad.xyz";
          window.MONAD_CHAIN_ID = config.monadChainId || 143;

          // Show auth modal if needed
          if (MIN_TOKEN_BALANCE > 0 && !sessionToken) {
            showAuthModal();
          } else if (userWallet) {
            updateWalletBadge(userWallet);
          }
          return config;
        } catch (error) {
          console.error("Failed to load config:", error);
          return null;
        }
      }

      function showStatus(msg, type = "success") {
        const statusDiv = document.getElementById("auth-status-display");
        statusDiv.innerHTML = `<div class="auth-status status-${type}">${msg}</div>`;
      }

      function showManualAuth() {
        document.getElementById("auto-connect-section").style.display = "none";
        document.getElementById("manual-auth-section").style.display = "block";
      }

      function showAutoConnect() {
        document.getElementById("auto-connect-section").style.display = "block";
        document.getElementById("manual-auth-section").style.display = "none";
        document.getElementById("challenge-display").style.display = "none";
        document.getElementById("btn-create-challenge").style.display = "block";
        document.getElementById("btn-verify").style.display = "none";
      }

      // ========== AUTOMATIC WALLET CONNECTION ==========
      async function connectWalletAuto() {
        showStatus("Connecting to wallet...", "info");

        if (typeof window.zooConnectWallet !== "function") {
          showStatus(
            "Wallet connector is still loading. Please refresh the page or use Manual Sign-In below.",
            "error",
          );
          return;
        }

        try {
          await window.zooConnectWallet();
        } catch (error) {
          console.error("Wallet connection error:", error);
          if (error.code === 4001 || error.code === "ACTION_REJECTED") {
            showStatus("Connection request denied", "error");
          } else {
            showStatus(`Error: ${error.message || "Connection failed"}`, "error");
          }
        }
      }

      async function requestAuthChallenge(walletAddress) {
        const challengeResponse = await fetch("/api/auth/challenge", {
          method: "GET",
          headers: { "X-Wallet-Address": walletAddress },
        });
        const challengeData = await challengeResponse.json();

        if (!challengeResponse.ok) {
          throw new Error(challengeData.error || "Failed to create challenge");
        }

        return challengeData.challenge;
      }

      async function verifyAuthSignature(walletAddress, signature) {
        const verifyResponse = await fetch("/api/auth/verify", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ wallet: walletAddress, signature }),
        });
        const verifyData = await verifyResponse.json();

        if (verifyResponse.ok && verifyData.session_token) {
          sessionToken = verifyData.session_token;
          userWallet = verifyData.wallet;
          localStorage.setItem("zoo_session_token", sessionToken);
          localStorage.setItem("zoo_wallet", userWallet);
          updateWalletBadge(userWallet);
          showStatus(
            `‚úì Logged in! Balance: ${verifyData.token_balance || "N/A"} ZOO tokens`,
            "success",
          );
          setTimeout(() => hideAuthModal(), 1500);
          return true;
        }

        showStatus(verifyData.error || "Authentication failed", "error");
        return false;
      }

      async function completeAuthentication(signer, walletAddress) {
        try {
          const challenge = await requestAuthChallenge(walletAddress);
          showStatus("Please sign the message in your wallet...", "info");

          let signature;
          try {
            signature = await signer.signMessage(challenge);
          } catch (signError) {
            if (signError.code === 4001 || signError.code === "ACTION_REJECTED") {
              showStatus("Signature request denied. Please try again.", "error");
            } else {
              showStatus(`Signing failed: ${signError.message || "Unknown error"}`, "error");
            }
            return;
          }

          showStatus("Verifying signature...", "info");
          await verifyAuthSignature(walletAddress, signature);
        } catch (error) {
          console.error("Authentication error:", error);
          showStatus(`Error: ${error.message || "Authentication failed"}`, "error");
        }
      }

      window.zooAuth = {
        requestChallenge: requestAuthChallenge,
        verifySignature: verifyAuthSignature,
      };

      async function createChallenge() {
        const walletInput = document.getElementById("wallet-input");
        const wallet = walletInput.value.trim();

        if (!wallet.match(/^0x[a-fA-F0-9]{40}$/i)) {
          showStatus("Invalid wallet address format", "error");
          return;
        }

        try {
          const challenge = await requestAuthChallenge(wallet);
          document.getElementById("challenge-display").style.display = "block";
          document.getElementById("challenge-text").textContent = challenge;
          document.getElementById("btn-create-challenge").style.display = "none";
          document.getElementById("btn-verify").style.display = "block";
          showStatus("Challenge created. Sign this message with your wallet.", "success");
        } catch (err) {
          showStatus(`Error: ${err.message}`, "error");
        }
      }

      async function verifySignature() {
        const wallet = document.getElementById("wallet-input").value.trim();
        const signature = document.getElementById("signature-input").value.trim();

        if (!wallet || !signature) {
          showStatus("Please provide wallet and signature", "error");
          return;
        }

        try {
          await verifyAuthSignature(wallet, signature);
        } catch (err) {
          showStatus(`Error: ${err.message}`, "error");
        }
      }

      function showAuthModal() {
        document.getElementById("auth-modal").classList.remove("hidden");
      }

      function hideAuthModal() {
        document.getElementById("auth-modal").classList.add("hidden");
      }

      function getAuthHeader() {
        return sessionToken ? { Authorization: `Bearer ${sessionToken}` } : {};
      }

      // Override controlRequest to include auth header
      const originalControlRequest = controlRequest;
      controlRequest = async function (path, body = {}) {
        const headers = { "Content-Type": "application/json", ...getAuthHeader() };
        const response = await fetch(path, {
          method: "POST",
          headers,
          body: JSON.stringify(body),
        });

        if (response.status === 401) {
          showAuthModal();
          throw new Error("Authentication required");
        }
        return response;
      };

      function updateWalletBadge(wallet) {
        document.getElementById("wallet-badge").style.display = "inline";
        document.getElementById("wallet-badge").innerHTML =
          `<span class="wallet-badge">${wallet.slice(0, 6)}...${wallet.slice(-4)}</span>`;
      }

      // Load config and check auth on page load
      loadConfig().then((config) => {
        console.log("Config loaded, waiting for Reown bundle...", config);

        // Wait for bundle to load
        const waitForBundle = () => {
          if (typeof window.initReownAppKit === "function") {
            console.log("Reown bundle ready, initializing AppKit with config:", config);
            window.initReownAppKit(config || {});
            fetchStatus();
            setInterval(fetchStatus, 2000);
          } else {
            console.log("Waiting for Reown bundle...");
            setTimeout(waitForBundle, 100);
          }
        };
        waitForBundle();
      });
    </script>
  </body>
</html>
